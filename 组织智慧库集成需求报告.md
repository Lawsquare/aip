# AI项目管理平台 - 组织智慧库集成需求报告

## 📋 项目概况

### 当前项目状态
- **项目名称**: AI项目管理平台 (AIP)
- **技术栈**: React + TypeScript + Supabase + n8n
- **开发环境**: http://localhost:5173
- **当前功能**: 用户可以在组织页面选择项目后与AI聊天，AI基于项目智慧库回答问题

### 现有聊天功能架构
1. **前端组件**: 
   - AIChat组件 (`src/components/Dashboard/AIChat.tsx`)
   - Dashboard组件 (`src/components/Dashboard/Dashboard.tsx`)
2. **API调用层**: n8n.ts (`src/lib/n8n.ts`) 
3. **后端处理**: n8n工作流 (`aip聊天生成历史.json`)
4. **数据存储**: Supabase数据库 (documents表)

### 当前工作流程
1. 用户在组织页面选择一个或多个项目
2. 用户输入问题
3. 前端调用n8n webhook，传递 `chatInput`、`project_id`、`user_id`
4. n8n工作流基于project_id进行向量搜索
5. AI基于检索到的项目文档生成回答

## 🎯 核心需求描述

### 主要需求
用户在组织页面与AI聊天时，希望AI能够**同时使用**两种知识源：
1. **项目智慧库**: 基于用户选中项目的documents (按project_id过滤)
2. **组织智慧库**: 基于当前组织的documents (按organization_id过滤 + title="组织智慧库")

### 新增功能要求
- **无需选择项目也可聊天**: 用户在组织页面可以不选择任何项目，直接与组织智慧库对话
- **双重知识源**: 选择项目后，AI同时使用项目智慧库和组织智慧库
- **向后兼容**: 保持原有的纯项目智慧库功能

### 具体使用场景

#### 场景1: 纯组织智慧库对话
- **触发条件**: 用户在组织页面，未选择任何项目
- **AI知识源**: 仅使用组织智慧库
- **典型问题**: "我们组织的规章制度是什么？"、"组织有什么政策规范？"

#### 场景2: 项目+组织双重智慧库
- **触发条件**: 用户在组织页面，选择了一个或多个项目
- **AI知识源**: 项目智慧库 + 组织智慧库
- **典型问题**: "这个项目如何符合我们组织的规范？"、"项目进展是否符合组织要求？"

#### 场景3: 纯项目智慧库(向后兼容)
- **触发条件**: 用户在非组织页面，或没有组织上下文
- **AI知识源**: 仅使用项目智慧库
- **典型问题**: "项目进度如何？"、"项目有什么技术难点？"

## 🔧 已完成的前端修改

### 修改的文件清单

#### 1. src/lib/n8n.ts
**主要修改**:
- `callN8nRAGAgent` 函数增加了可选的 `organizationId` 参数
- `callN8nRAGAgentLocal` 函数增加了可选的 `organizationId` 参数
- `projectId` 参数改为可选 (`projectId?: string | string[]`)
- 智能构建请求体，只传递存在的参数

**修改前**:
```javascript
export const callN8nRAGAgentLocal = async (
  chatInput: string,
  projectId: string | string[]
): Promise<N8nChatResponse> => {
  // ...
  body: JSON.stringify({
    chatInput: chatInput,
    project_id: projectId,
    user_id: user.id
  })
}
```

**修改后**:
```javascript
export const callN8nRAGAgentLocal = async (
  chatInput: string,
  projectId?: string | string[],
  organizationId?: string
): Promise<N8nChatResponse> => {
  // 构建请求体
  const requestBody: any = {
    chatInput: chatInput,
    user_id: user.id
  }

  // 如果有项目ID，添加到请求中
  if (projectId) {
    requestBody.project_id = projectId
    console.log('📋 包含项目智慧库:', projectId)
  }

  // 如果有组织ID，添加到请求中
  if (organizationId) {
    requestBody.organization_id = organizationId
    console.log('📋 包含组织智慧库:', organizationId)
  }
}
```

#### 2. src/components/Dashboard/AIChat.tsx
**主要修改**:
- 移除"必须选择项目"的限制
- 在组织页面时自动传递 `organization?.id`
- 支持无项目选择的纯组织智慧库对话

**修改前**:
```javascript
if (selectedProjects.length === 0) {
  alert('请先选择至少一个项目')
  return
}

const result = await callN8nRAGAgentLocal(input.trim(), projectId)
```

**修改后**:
```javascript
// 如果在组织页面但没有选择项目，检查是否有组织ID
if (selectedProjects.length === 0 && !organization?.id) {
  alert('请先选择至少一个项目或确保在组织页面中')
  return
}

// 根据选择情况决定传递的参数
let projectId: string | string[] | undefined = undefined
if (selectedProjects.length > 0) {
  projectId = selectedProjects.length === 1 ? selectedProjects[0] : selectedProjects
}

// 调用n8n RAG系统
const result = await callN8nRAGAgentLocal(
  input.trim(), 
  projectId, 
  organization?.id // 传递组织ID以启用组织智慧库
)
```

### 前端发送的数据格式

#### 类型1: 纯组织智慧库请求
```json
{
  "chatInput": "我们组织的规章制度是什么？",
  "user_id": "2783930b-6a0a-45b2-a515-41ec5c040b68",
  "organization_id": "d03b6947-f08d-41bd-86c0-c92c3c4630b0"
}
```

#### 类型2: 项目+组织双重智慧库请求
```json
{
  "chatInput": "这个项目如何符合我们组织的规范？",
  "user_id": "2783930b-6a0a-45b2-a515-41ec5c040b68",
  "project_id": "990ea8e2-2562-4fea-ba0b-0b6695efc605",
  "organization_id": "d03b6947-f08d-41bd-86c0-c92c3c4630b0"
}
```

#### 类型3: 纯项目智慧库请求(向后兼容)
```json
{
  "chatInput": "项目进度如何？",
  "user_id": "2783930b-6a0a-45b2-a515-41ec5c040b68",
  "project_id": "990ea8e2-2562-4fea-ba0b-0b6695efc605"
}
```

## 📊 数据库结构

### documents表结构
```sql
CREATE TABLE documents (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  content TEXT,
  project_id UUID REFERENCES projects(id),
  organization_id UUID REFERENCES organizations(id),
  user_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  metadata JSONB
);
```

### 关键数据查询逻辑
- **项目文档查询**: `SELECT * FROM documents WHERE project_id = ?`
- **组织智慧库查询**: `SELECT * FROM documents WHERE organization_id = ? AND title = '组织智慧库'`
- **双重查询**: 需要合并上述两个查询的结果

### 现有数据示例
- 每个新创建的项目都会自动生成一个项目智慧库文档
- 每个新创建的组织都会自动生成一个"组织智慧库"文档
- 用户上传的文档都会关联到对应的project_id和organization_id

## 🚨 待解决的核心问题

### n8n工作流改造需求

#### 当前工作流问题
1. **单一向量搜索**: 只支持基于 `project_id` 的向量搜索
2. **参数处理局限**: 无法处理 `organization_id` 参数
3. **无条件分支**: 无法根据不同参数组合执行不同的搜索逻辑
4. **结果合并缺失**: 无法合并多个向量搜索的结果

#### 需要实现的工作流逻辑

**步骤1: 参数检查与分支判断**
- 检查输入参数中是否包含 `project_id` 和 `organization_id`
- 根据参数组合决定执行哪种搜索策略
- 设置相应的执行标志

**步骤2: 条件向量搜索**
- **项目文档搜索**: 当存在 `project_id` 时执行
  - 搜索条件: `project_id = ?`
  - 返回该项目的所有相关文档
- **组织智慧库搜索**: 当存在 `organization_id` 时执行
  - 搜索条件: `organization_id = ? AND title = '组织智慧库'`
  - 返回该组织的智慧库文档

**步骤3: 结果合并与处理**
- 合并两个向量搜索的结果
- 为每个结果添加来源标识(项目文档/组织智慧库)
- 按相似度排序，确保最相关的内容优先

**步骤4: AI提示词构建**
- 根据搜索模式调整提示词
- 明确告知AI当前使用的知识源类型
- 要求AI在回答中区分信息来源

### 技术实现难点

#### 1. n8n条件执行
- **问题**: 如何在n8n中实现基于参数的条件执行
- **需求**: 某些向量搜索节点只在特定条件下执行
- **解决方案**: 使用IF节点或条件表达式控制节点执行

#### 2. 多重向量搜索
- **问题**: 如何在一个工作流中实现两个独立的Supabase Vector Search
- **需求**: 两个搜索可能同时执行，也可能只执行其中一个
- **解决方案**: 复制现有的向量搜索节点，配置不同的过滤条件

#### 3. 复杂过滤条件
- **问题**: 组织智慧库需要同时过滤 `organization_id` 和 `title`
- **当前**: 只支持简单的 `project_id` 过滤
- **需求**: `WHERE organization_id = ? AND title = '组织智慧库'`

#### 4. 结果合并逻辑
- **问题**: 如何合并两个向量搜索的结果
- **需求**: 保持相似度排序，添加来源标识
- **挑战**: 处理某个搜索无结果的情况

## 🌐 测试信息

### API端点配置
- **生产环境**: `https://n8n.aifunbox.com/webhook/1afe3c51-e81d-477b-b3e6-0686bc772534`
- **开发环境**: 通过代理访问 `/api/n8n/webhook/1afe3c51-e81d-477b-b3e6-0686bc772534`
- **本地应用**: `http://localhost:5173`

### Postman测试用例

#### 测试1: 纯组织智慧库
```bash
POST https://n8n.aifunbox.com/webhook/1afe3c51-e81d-477b-b3e6-0686bc772534
Content-Type: application/json

{
  "chatInput": "我们组织有什么规章制度？",
  "user_id": "真实用户ID",
  "organization_id": "真实组织ID"
}
```

#### 测试2: 双重智慧库
```bash
POST https://n8n.aifunbox.com/webhook/1afe3c51-e81d-477b-b3e6-0686bc772534
Content-Type: application/json

{
  "chatInput": "这个项目符合组织规范吗？",
  "user_id": "真实用户ID",
  "project_id": "真实项目ID",
  "organization_id": "真实组织ID"
}
```

#### 测试3: 纯项目智慧库
```bash
POST https://n8n.aifunbox.com/webhook/1afe3c51-e81d-477b-b3e6-0686bc772534
Content-Type: application/json

{
  "chatInput": "项目进度如何？",
  "user_id": "真实用户ID",
  "project_id": "真实项目ID"
}
```

### 获取测试数据的方法
- **用户ID**: 从Supabase的 `auth.users` 表获取
- **项目ID**: 从 `projects` 表获取
- **组织ID**: 从 `organizations` 表获取，例如: `d03b6947-f08d-41bd-86c0-c92c3c4630b0`

## 📝 期望实现结果

### 用户体验改进
1. **更灵活的对话方式**
   - 用户可以直接与组织智慧库对话，无需选择项目
   - 选择项目后获得更全面的回答(项目+组织知识)

2. **更智能的回答内容**
   - AI能够区分信息来源，明确标注是来自项目文档还是组织智慧库
   - 回答更加全面，既有项目特定信息，又有组织通用规范

3. **更好的上下文理解**
   - AI理解当前的组织环境，回答更符合组织文化和规范
   - 项目相关问题能够结合组织政策给出建议

### 技术实现目标
1. **n8n工作流智能化**
   - 能够根据输入参数自动选择搜索策略
   - 支持单一搜索、双重搜索等多种模式
   - 错误处理完善，某个搜索失败不影响整体流程

2. **向量搜索优化**
   - 两个向量搜索结果正确合并，不丢失相关信息
   - 相似度排序准确，最相关内容优先展示
   - 搜索性能良好，响应时间控制在合理范围

3. **AI回答质量提升**
   - 提示词能够清楚区分不同知识源
   - AI回答中明确标注信息来源
   - 回答逻辑清晰，项目信息和组织信息有机结合

### 成功验收标准
- ✅ 用户在组织页面不选择项目可以直接对话
- ✅ 选择项目后AI回答融合项目和组织两种知识
- ✅ AI回答中能明确区分信息来源
- ✅ 三种请求类型都能正确处理
- ✅ 向量搜索结果准确，无遗漏
- ✅ 系统性能稳定，响应时间合理

## 🔄 实施建议

### 开发优先级
1. **高优先级**: n8n工作流改造(核心功能)
2. **中优先级**: AI提示词优化(用户体验)
3. **低优先级**: 前端UI优化(已基本完成)

### 风险评估
- **技术风险**: n8n复杂条件分支和结果合并的实现难度
- **数据风险**: 向量搜索性能可能受到影响
- **兼容性风险**: 需要确保不影响现有功能

### 建议的开发者技能要求
- **n8n工作流开发经验**: 熟悉条件分支、代码节点、向量搜索
- **Supabase经验**: 了解向量搜索和复杂查询条件
- **AI提示词工程**: 能够设计有效的多知识源提示词

## 📞 项目状态

**当前状态**: 前端代码修改已完成，等待n8n工作流改造
**紧急程度**: 中等
**预计工期**: 2-3个工作日
**关键依赖**: 需要有经验的n8n开发者

---

**报告生成时间**: 2024年12月
**文档版本**: v1.0
**联系方式**: 项目开发团队